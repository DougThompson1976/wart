(defun foo() 34)
(test-wc "simple defun"
  :valueof (foo)
  :should be 34)

(progn
  (defun foo0() 3)
  (defun foo1() (+ 1 (foo0))))
(test-wc "nested defuns"
  :valueof (foo1)
  :should be 4)

(progn
  (defmacro foo2(n) `(+ 1 ,n))
  (defmacro foo3(n) `(+ 1 (foo2 ,n))))
(test-wc "nested macros"
  :valueof (foo3 2)
  :should be 4)

(test "vars-in-paramlist returns simple params"
  :valueof (vars-in-paramlist '(a b c))
  :should be '(a b c))

(test "vars-in-paramlist returns varargs param"
  :valueof (vars-in-paramlist 'a)
  :should be '(a))

(test "vars-in-paramlist returns rest param"
  :valueof (vars-in-paramlist '(a b c . d))
  :should be '(a b c d))

(test "vars-in-paramlist returns optional params"
  :valueof (vars-in-paramlist '(a ? b 2 c 3 . d))
  :should be '(a b c d))

(test "keyword-args works"
  :valueof (keyword-args '(1 2 :a 3) '())
  :should be '((a . 3)))

(test "keyword-args works with rest args"
  :valueof (keyword-args '(1 2 :a 3) 'a)
  :should be '((a 3)))

(test "strip-keyword-args works"
  :valueof (strip-keyword-args '(1 2 :a 3 4) '())
  :should be '(1 2 4))

(test "strip-keyword-args works on rest args"
  :valueof (strip-keyword-args '(1 2 :a 3 4) 'a)
  :should be '(1 2))

(test "optional-params works - 1"
  :valueof (optional-params 'a)
  :should be '())
(test "optional-params 1"
  :valueof (optional-params '(a b c))
  :should be '())
(test "optional-params 2"
  :valueof (optional-params '(a b c ? d e))
  :should be '((d . e)))
(test "optional-params 3"
  :valueof (optional-params '(a b c ? d e f))
  :should be '((d . e) (f)))
(test "optional-params 4"
  :valueof (optional-params '(a b c ? d e f nil))
  :should be '((d . e) (f . nil)))
(test "optional-params 5"
  :valueof (optional-params '(a b c ? d e f nil . g))
  :should be '((d . e) (f . nil)))

(test "get-arg works for missing arg"
  :valueof (get-arg 'c 'a 1 ())
  :should be nil) ;#f

(test "get-arg works for required args"
  :valueof (get-arg 'c '(a b c) '(1 2 3) ())
  :should be 3)

(test "get-arg works for varargs"
  :valueof (get-arg 'a 'a '(1 2 3) ())
  :should be '(1 2 3))

(test "get-arg works for rest args"
  :valueof (get-arg 'd '(a (b c) . d) '(1 (2 3) 4 5 6) ())
  :should be '(4 5 6))

(test "get-arg works for destructured args"
  :valueof (get-arg 'b '(a (b c))
                       '(1 (2 3)) ())
  :should be 2)

(test "get-arg works for destructured args - 2"
  :valueof (get-arg 'f '(a (b c (d e f)))
                       '(1 (2 3 (4 5 6))) ())
  :should be 6)

(test "get-arg works for missing destructured args"
  :valueof (get-arg 'x '(a (b c (d e f)))
                       '(1 (2 3 (4 5 6))) ())
  :should be nil) ;#f

(test "get-arg works for destructuring and rest args"
  :valueof (get-arg 'g '(a (b c (d e f) . g))
                       '(1 (2 3 (4 5 6) 7 8)) ())
  :should be '(7 8))

(test "get-arg works for destructuring and rest args - 2"
  :valueof (get-arg 'f '(a (b c (d e f) . g))
                       '(1 (2 3 (4 5 6) 7 8)) ())
  :should be 6)

(test "get-arg works for destructuring and rest args - 3"
  :valueof (get-arg 'x '(a (b c (d e f) . g))
                       '(1 (2 3 (4 5 6) 7 8)) ())
  :should be nil) ;#f

(test "get-arg works for destructuring and rest args - 4"
  :valueof (get-arg 'f '(a (b c (d e . f) . g))
                       '(1 (2 3 (4 5 6 7) 7 8)) ())
  :should be '(6 7))

(test "get-arg works for destructuring and rest args - 5"
  :valueof (get-arg 'f '(a (b c (d e . f) . g))
                       '(1 (2 3 (4 5) 7 8)) ())
  :should be '())

(test "get-arg works for keyword args"
  :valueof (get-arg 'a '(a (b c (d e f) . g))
                       '((2 3 (4 5 6) 7 8)) '((a . 1)))
  :should be 1)

(test "get-arg works on args with keywords"
  :valueof (get-arg 'd '(a (b c (d e f) . g))
                       '((2 3 (4 5 6) 7 8)) '((a . 1)))
  :should be 4)

(test "get-arg for missing rest args"
  :valueof (get-arg 'rest 'rest () ())
  :should be ())

(test "get-arg returns an illegal literal for missing, hopefully optional, params - 1"
  :valueof (get-arg 'a '(a) () ())
  :should be nil) ;#f

(test "get-arg returns an illegal literal for missing, hopefully optional, params - 2"
  :valueof (get-arg 'e '(a b c e f . d) '(1 2 3) '())
  :should be nil) ;#f



(wc-eval '(def foo4() 34))
(test-wc "simple def"
  :valueof (foo4)
  :should be 34)

(wc-eval '(mac foo5(n) `(+ ,n 1)))
(test-wc "simple mac"
  :valueof (foo5 32)
  :should be 33)

(wc-eval '(def foo6() (cons 3 4)))
(test-wc "def 2"
  :valueof (foo6)
  :should be (cons 3 4))

(wc-eval '(def foo7 args args))
(test-wc "just a rest arg without parens"
    :valueof (foo7 3 4 5)
    :should be '(3 4 5))

(wc-eval '(def foo8(a . b) b))
(test-wc "dotted rest"
  :valueof (foo8 3 4)
  :should be '(4))

(test-wc "rest args are optional"
  :valueof (foo8 3)
  :should be nil)

(wc-eval '(def foo9((a b)) b))
(test-wc "destructured args"
  :valueof (foo9 '(3 4))
  :should be 4)

(wc-eval '(def foo10((a b) . c) b))
(test-wc "destructured args + dotted rest"
  :valueof (foo10 '(3 4) 5)
  :should be 4)

(test-wc "destructured args + dotted rest for fn"
  :valueof (call (fn ((a b) . c) b) '(3 4) 5)
  :should be 4)

(wc-eval '(def foo12(a b) (- a b)))
(test-wc "allow param names"
  :valueof (foo12 :a 3 :b 4)
  :should be -1)

(test-wc "allow just some param names"
  :valueof (foo12 :a 3 4)
  :should be -1)

(test-wc "allow args in any order when giving param names"
  :valueof (foo12 :b 3 :a 4)
  :should be 1)

(test-wc "take positional args in order after keyword args have been matched"
  :valueof (foo12 3 :a 4)
  :should be 1)

(wc-eval '(def foo13(a ? b nil) (cons a b)))
(test-wc "optional param"
  :valueof (foo13 3)
  :should be '(3))

(wc-eval '(def foo14(a ? b 4) (cons a b)))
(test-wc "optional param with a default"
  :valueof (foo14 3)
  :should be '(3 . 4))

(test-wc "optional named arg"
  :valueof (foo14 :a 3)
  :should be '(3 . 4))

(test-wc "distinguish destructured from optional params"
  :valueof (call (fn((a b)) (list a b)) '(1 (2)))
  :should be '(1 (2)))

(test-wc "distinguish destructured from optional params - 2"
  :valueof (call (fn((a (b))) (list a b)) '(1 (2)))
  :should be '(1 2))

(test-wc "args should override optional params"
  :valueof (foo14 3 :b 2)
  :should be '(3 . 2))

(test-wc "optional arg without naming"
  :valueof (foo14 3 2)
  :should be '(3 . 2))

(test-wc "nil overrides default for optional arg"
  :valueof (foo14 3 :b nil)
  :should be '(3))

(test-wc "nil overrides default for optional arg without naming"
  :valueof (foo14 3 nil)
  :should be '(3))

(test-wc "allow optional params to refer to variables"
  :valueof (_let a 3 (call (fn(? x a) x)))
  :should be 3)

(wc-eval '(def foo15(a ? b 4 c nil) (cons b c)))
(test-wc "multiple optional params"
  :valueof (foo15 3)
  :should be '(4))

(test-wc "allow optional named args out of order"
  :valueof (foo15 3 :c 2 :b nil)
  :should be '(nil . 2))

(test-wc "allow optional args in order without naming"
  :valueof (foo15 3 nil 2)
  :should be '(nil . 2))

(wc-eval '(def foo16(a . b) b))
(test-wc "rest args can be named"
  :valueof (foo16 3 :b 4 5)
  :should be '(4 5))

(wc-eval '(def foo17(a ? b 3 . c) (cons b c)))
(test-wc "optional + named rest args"
  :valueof (foo17 2 :c 3)
  :should be '(3 3))

(test-wc "optional + named rest args - 2"
  :valueof (foo17 2 4 :c 3)
  :should be '(4 3))

(test-wc "optional + named rest args - 3"
  :valueof (foo17 2 4 3 1)
  :should be '(4 3 1))

(test-wc "optional + named rest args - 3"
  :valueof (foo17 2 :b 4 3)
  :should be '(4 3))

(wc-eval '(def foo18(a ? b nil c 3 . body) (list b c body)))
(test-wc "call with some optional and rest args without naming"
  :valueof (foo18 3 4 :body 4 5)
  :should be '(4 3 (4 5)))

(test-wc "call with some named optional and rest args"
  :valueof (foo18 3 :c 4 :body 4 5)
  :should be '(nil 4 (4 5)))

(test-wc "tuples works"
  :valueof (tuples '(1 2 3 4 5 6) 3)
  :should be '((1 2 3) (4 5 6)))

(test-wc "tuples works with unbalanced lists"
  :valueof (tuples '(1 2 3 4 5) 3)
  :should be '((1 2 3) (4 5)))

(test-wc "tuples works with n 1"
  :valueof (tuples '(1 2 3 4 5) 1)
  :should be (map 'list #'list '(1 2 3 4 5)))
