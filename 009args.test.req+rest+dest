(defun foo() 34)
(test-wart "simple defun works as before"
  :valueof (foo)
  :should be 34)

(progn
  (defun foo0() 3)
  (defun foo1() (+ 1 (foo0))))
(test-wart "nested defuns work as before"
  :valueof (foo1)
  :should be 4)

(progn
  (defmacro foo2(n) `(+ 1 ,n))
  (defmacro foo3(n) `(+ 1 (foo2 ,n))))
(test-wart "nested macros work as before"
  :valueof (foo3 2)
  :should be 4)

(test "get-arg works for missing arg"
  :valueof (multiple-value-list
             (get-arg 'c 'a 1))
  :should be (list nil 'no-arg))

(test "get-arg works for required args"
  :valueof (multiple-value-list
             (get-arg 'c '(a b c) '(1 2 3)))
  :should be (list 3))

(test "get-arg works for varargs"
  :valueof (multiple-value-list
             (get-arg 'a 'a '(1 2 3)))
  :should be (list '(1 2 3)))

(test "get-arg works for rest args"
  :valueof (multiple-value-list
             (get-arg 'd '(a (b c) . d) '(1 (2 3) 4 5 6)))
  :should be (list '(4 5 6)))

(test "get-arg works for destructured args"
  :valueof (multiple-value-list
             (get-arg 'b '(a (b c))
                         '(1 (2 3))))
  :should be (list 2))

(test "get-arg works for destructured args - 2"
  :valueof (multiple-value-list
             (get-arg 'f '(a (b c (d e f)))
                         '(1 (2 3 (4 5 6)))))
  :should be (list 6))

(test "get-arg works for missing destructured args"
  :valueof (multiple-value-list
             (get-arg 'x '(a (b c (d e f)))
                         '(1 (2 3 (4 5 6)))))
  :should be (list nil 'no-arg))

(test "get-arg works for destructuring and rest args"
  :valueof (multiple-value-list
             (get-arg 'g '(a (b c (d e f) . g))
                         '(1 (2 3 (4 5 6) 7 8))))
  :should be (list '(7 8)))

(test "get-arg works for destructuring and rest args - 2"
  :valueof (multiple-value-list
             (get-arg 'f '(a (b c (d e f) . g))
                       '(1 (2 3 (4 5 6) 7 8))))
  :should be (list 6))

(test "get-arg works for destructuring and rest args - 3"
  :valueof (multiple-value-list
             (get-arg 'x '(a (b c (d e f) . g))
                         '(1 (2 3 (4 5 6) 7 8))))
  :should be (list nil 'no-arg))

(test "get-arg works for destructuring and rest args - 4"
  :valueof (multiple-value-list
             (get-arg 'f '(a (b c (d e . f) . g))
                         '(1 (2 3 (4 5 6 7) 7 8))))
  :should be (list '(6 7)))

(test "get-arg works for destructuring and rest args - 5"
  :valueof (multiple-value-list
             (get-arg 'f '(a (b c (d e . f) . g))
                         '(1 (2 3 (4 5) 7 8))))
  :should be (list nil))

(test "get-arg for missing rest args"
  :valueof (multiple-value-list (get-arg 'rest 'rest ()))
  :should be (list nil))

(test "get-arg works for nil args"
  :valueof (multiple-value-list (get-arg 'b '(a b) '(3 nil)))
  :should be (list nil))

(test "get-arg returns an illegal literal for missing, hopefully optional, params - 1"
  :valueof (multiple-value-list (get-arg 'a '(a) ()))
  :should be (list nil 'no-arg))

(test "get-arg returns an illegal literal for missing, hopefully optional, params - 2"
  :valueof (multiple-value-list (get-arg 'e '(a b c e f . d) '(1 2 3)))
  :should be (list nil 'no-arg))

(test "get-greedy-rest-args works without keyword args"
  :valueof (multiple-value-list (get-greedy-rest-args 'c '(a b . c) '(1 2 3)))
  :should be (list '(3)))



(wt-eval '(def foo4() 34))
(test-wart "simple def"
  :valueof (foo4)
  :should be 34)

(wt-eval '(mac foo5(n) `(+ ,n 1)))
(test-wart "simple mac"
  :valueof (foo5 32)
  :should be 33)

(wt-eval '(def foo6() (cons 3 4)))
(test-wart "def 2"
  :valueof (foo6)
  :should be (cons 3 4))

(wt-eval '(def foo7 args args))
(test-wart "just a rest arg without parens"
    :valueof (foo7 3 4 5)
    :should be '(3 4 5))

(wt-eval '(def foo8(a . b) b))
(test-wart "dotted rest"
  :valueof (foo8 3 4)
  :should be '(4))

(test-wart "rest args are optional"
  :valueof (foo8 3)
  :should be nil)

(test-wart "'required' params are really just optional"
  :valueof (foo8)
  :should be nil)

(wt-eval '(def foo9((a b)) b))
(test-wart "destructured args"
  :valueof (foo9 '(3 4))
  :should be 4)

(wt-eval '(def foo10((a b) . c) b))
(test-wart "destructured args + dotted rest"
  :valueof (foo10 '(3 4) 5)
  :should be 4)

(test-wart "destructured args + dotted rest for fn"
  :valueof (call (fn ((a b) . c) b) '(3 4) 5)
  :should be 4)

; integration test: bracket + fn + call
(test-wart "call works on lambdas"
  :valueof (call [+ _ 1] 3)
  :should be 4)
