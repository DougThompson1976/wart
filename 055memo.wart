(def memo(f)
  (with (cache (table)
         nilcache (table))
    (fn args
      (or cache.args
          (and (no nilcache.args)
               (aif (apply f args)
                    (= cache.args it)
                    (= nilcache.args t)))))))

(mac defmemo(name parms . body)
  `(perform
     (= (symbol-function ',name)
        (memo (fn ,parms ,@body)))))
