(require :sb-posix)

; clone a process that stops after executing child
(def fork(child)
  (let pid (sb-posix:fork)
    (if (zerop pid)
      (after
        (call child)
      :do
        (quit)))))

(synonym wait-for-children sb-posix:wait
         getpid sb-posix:getpid)



;; Threads
(mac spawn args
  (if (and (singlep args)
           (isa car.args 'function))
    `(perform (sb-thread:make-thread ,car.args))
    `(perform (call 'sb-thread:make-thread (fn() ,@args)))))
