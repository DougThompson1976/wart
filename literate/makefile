a.out: makefile tangle/tangle wart.cc
	g++ -g -Wall -Wextra -fno-strict-aliasing wart.cc
	-@./a.out test

test_all:
	# Sucks to have to explicitly name files
	for target in 009 029 030 031 032 033 034; \
	do \
		command echo $$target*; \
		build_and_test_until $$target; \
	done

# To see what the program looks like after all layers have been applied, read
# wart.cc
wart.cc: 0*
	./tangle/tangle --until 999 > wart.cc
	@make autogenerated_lists >/dev/null

tangle/tangle:
	cd tangle && make

# auto-generated files; by convention they end in '_list'.
.PHONY: autogenerated_lists
autogenerated_lists: wart.cc function_list test_list primfn_list

function_list: wart.cc
	@grep -h "^[^ #].*) {" wart.cc |sed 's/ {.*/;/' > function_list
	@grep -h "^COMPILE_FN" wart.cc |sed 's/.*COMPILE_FN(\([^,]*\), \([^,]*\), \([^,]*\),$$/cell* \2();/' >> function_list

test_list: wart.cc
	@grep -h "^[[:space:]]*void test_" wart.cc |sed 's/^\s*void \(.*\)() {.*/\1,/' > test_list

primfn_list: wart.cc
	@grep -h "^COMPILE_FN" wart.cc |sed 's/.*COMPILE_FN(\([^,]*\), \([^,]*\), \([^,]*\),$$/{ "\1", \3, \2 },/' > primfn_list

clean:
	cd tangle && make clean
	rm -rf wart.cc a.out* *_list

# scenarios tested
#   make clean; git status
#   make clean; make
#   make clean; build_and_test_until 010
#   build_and_test_until 029, 030, 031, etc.
